;; put tests here

(fiasco:define-test-package #:cl-hashing/test
    (:use :cl :cl-hashing))

(in-package #:cl-hashing/test)

(deftest test-bytes->le ()
  (is (= #xdeadbeef (cl-hashing::bytes->le32 (vector #xef #xbe #xad #xde) 0)))
  (is (= #xdeadbeefdeadbeef (cl-hashing::bytes->le64 (vector #xef #xbe #xad #xde #xef #xbe #xad #xde) 0))))

(deftest test-fnv ()
  (multiple-value-bind (buffer output input) (hash-io-context)
    (hash-simple-string output "qwertyuiop")
    (is (= #x9b89b808 (fnv1a/32 buffer 10)))
    (is (= #x6a297d225dc8acc8 (fnv1a/64 buffer 10)))))

(deftest test-xxhash/32 ()
  (multiple-value-bind (buffer output input) (hash-io-context)
    (hash-simple-string output "asdf")
    (is (= 1584409650 (xxhash/32 buffer (fast-io::output-buffer-len output))))
    (reset-context output input)
    (hash-simple-string output "qwertyuiop")
    (is (= 1976878101 (xxhash/32 buffer (fast-io::output-buffer-len output))))
    (reset-context output input)
    (hash-simple-string output "abcdefghijklmnopqrstuvwxyz")
    (is (= 1671515487 (xxhash/32 buffer (fast-io::output-buffer-len output))))))

(deftest test-xxhash/64 ()
  (multiple-value-bind (buffer output input) (hash-io-context)
    (hash-simple-string output "b")
    (is (= 8666379929374662555 (xxhash/64 buffer 1)))
    (reset-context output input)
    (hash-simple-string output "asdf")
    (is (= 4708639809588864798 (xxhash/64 buffer (fast-io::output-buffer-len output))))
    (reset-context output input)
    (hash-simple-string output "023456789")
    (is (= 7657887521216858946 (xxhash/64 buffer (fast-io::output-buffer-len output))))
    (reset-context output input)
    (hash-simple-string output "abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz1")
    (is (= 7493943686480554688 (xxhash/64 buffer (fast-io::output-buffer-len output))))))
 
(deftest test-siphash ()
  (let ((buffer1 (make-array 8 :element-type '(unsigned-byte 8) :initial-contents '(1 2 3 4 5 6 7 8)))
        (buffer2 (make-array 19 :element-type '(unsigned-byte 8)
                             :initial-contents '(1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19)))
        (key #x18171615141312111817161514131211))
    (is (= #xC266649AFC8073CD (siphash buffer2 19 key 64 2 4)))
    (is (= #xC266649AFC8073CD (siphash buffer2 19 key)))
    (is (= #xE8E704BCA160ED28 (siphash buffer1 8 key 64 2 4)))
    (is (= #x1ABA65FE6E3BDA5F12AE34E5197A8D23 (siphash buffer2 19 key 128 2 4)))))
